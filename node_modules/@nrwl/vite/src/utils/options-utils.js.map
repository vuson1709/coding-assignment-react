{"version":3,"sources":["../../../../../packages/vite/src/utils/options-utils.ts"],"sourcesContent":["import {\n  ExecutorContext,\n  joinPathFragments,\n  logger,\n  parseTargetString,\n  readTargetOptions,\n} from '@nrwl/devkit';\nimport { existsSync } from 'fs';\nimport { join, relative } from 'path';\nimport {\n  BuildOptions,\n  InlineConfig,\n  PluginOption,\n  searchForWorkspaceRoot,\n  ServerOptions,\n} from 'vite';\nimport { ViteDevServerExecutorOptions } from '../executors/dev-server/schema';\nimport replaceFiles from '../../plugins/rollup-replace-files.plugin';\nimport { ViteBuildExecutorOptions } from '../executors/build/schema';\n\nexport function getViteSharedConfig(\n  options: ViteBuildExecutorOptions,\n  clearScreen: boolean | undefined,\n  context: ExecutorContext\n): InlineConfig {\n  const projectRoot =\n    context.projectsConfigurations.projects[context.projectName].root;\n\n  return {\n    mode: options.mode,\n    root: projectRoot,\n    base: options.base,\n    configFile: normalizeViteConfigFilePath(projectRoot, options.configFile),\n    plugins: [replaceFiles(options.fileReplacements) as PluginOption],\n    optimizeDeps: { force: options.force },\n    clearScreen: clearScreen,\n    logLevel: options.logLevel,\n  };\n}\n\nexport function normalizeViteConfigFilePath(\n  projectRoot: string,\n  configFile?: string\n): string {\n  return configFile && existsSync(joinPathFragments(configFile))\n    ? configFile\n    : existsSync(joinPathFragments(`${projectRoot}/vite.config.ts`))\n    ? joinPathFragments(`${projectRoot}/vite.config.ts`)\n    : existsSync(joinPathFragments(`${projectRoot}/vite.config.js`))\n    ? joinPathFragments(`${projectRoot}/vite.config.js`)\n    : undefined;\n}\n\nexport function getViteServerOptions(\n  options: ViteDevServerExecutorOptions,\n  context: ExecutorContext\n): ServerOptions {\n  const projectRoot =\n    context.projectsConfigurations.projects[context.projectName].root;\n  const serverOptions: ServerOptions = {\n    host: options.host,\n    port: options.port,\n    https: options.https,\n    hmr: options.hmr,\n    open: options.open,\n    cors: options.cors,\n  };\n\n  if (options.proxyConfig) {\n    const proxyConfigPath = options.proxyConfig\n      ? join(context.root, options.proxyConfig)\n      : join(projectRoot, 'proxy.conf.json');\n\n    if (existsSync(proxyConfigPath)) {\n      logger.info(`Loading proxy configuration from: ${proxyConfigPath}`);\n      serverOptions.proxy = require(proxyConfigPath);\n      serverOptions.fs = {\n        allow: [\n          searchForWorkspaceRoot(joinPathFragments(projectRoot)),\n          joinPathFragments(context.root, 'node_modules/vite'),\n        ],\n      };\n    }\n  }\n\n  return serverOptions;\n}\n\nexport function getNxTargetOptions(target: string, context: ExecutorContext) {\n  const targetObj = parseTargetString(target, context.projectGraph);\n  return readTargetOptions(targetObj, context);\n}\n\nexport function getViteBuildOptions(\n  options: ViteBuildExecutorOptions,\n  context: ExecutorContext\n): BuildOptions {\n  const projectRoot =\n    context.projectsConfigurations.projects[context.projectName].root;\n\n  return {\n    outDir: relative(projectRoot, options.outputPath),\n    emptyOutDir: true,\n    reportCompressedSize: true,\n    cssCodeSplit: true,\n    target: 'esnext',\n    commonjsOptions: {\n      transformMixedEsModules: true,\n    },\n    sourcemap: options.sourcemap,\n    minify: options.minify,\n    manifest: options.manifest,\n    ssrManifest: options.ssrManifest,\n    ssr: options.ssr,\n  };\n}\n"],"names":["getViteSharedConfig","normalizeViteConfigFilePath","getViteServerOptions","getNxTargetOptions","getViteBuildOptions","options","clearScreen","context","projectRoot","projectsConfigurations","projects","projectName","root","mode","base","configFile","plugins","replaceFiles","fileReplacements","optimizeDeps","force","logLevel","existsSync","joinPathFragments","undefined","serverOptions","host","port","https","hmr","open","cors","proxyConfig","proxyConfigPath","join","logger","info","proxy","require","fs","allow","searchForWorkspaceRoot","target","targetObj","parseTargetString","projectGraph","readTargetOptions","outDir","relative","outputPath","emptyOutDir","reportCompressedSize","cssCodeSplit","commonjsOptions","transformMixedEsModules","sourcemap","minify","manifest","ssrManifest","ssr"],"mappings":"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"}