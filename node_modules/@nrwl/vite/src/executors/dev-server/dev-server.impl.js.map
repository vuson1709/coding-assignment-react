{"version":3,"sources":["../../../../../../packages/vite/src/executors/dev-server/dev-server.impl.ts"],"sourcesContent":["import 'dotenv/config';\nimport { ExecutorContext } from '@nrwl/devkit';\nimport { createServer, InlineConfig, mergeConfig, ViteDevServer } from 'vite';\n\nimport {\n  getViteSharedConfig,\n  getNxTargetOptions,\n  getViteServerOptions,\n  getViteBuildOptions,\n} from '../../utils/options-utils';\n\nimport { ViteDevServerExecutorOptions } from './schema';\nimport { ViteBuildExecutorOptions } from '../build/schema';\n\nexport default async function* viteDevServerExecutor(\n  options: ViteDevServerExecutorOptions,\n  context: ExecutorContext\n): AsyncGenerator<{ success: boolean; baseUrl: string }> {\n  // Retrieve the option for the configured buildTarget.\n  const buildTargetOptions: ViteBuildExecutorOptions = getNxTargetOptions(\n    options.buildTarget,\n    context\n  );\n\n  // Merge the options from the build and dev-serve targets.\n  // The latter takes precedence.\n  const mergedOptions = {\n    ...buildTargetOptions,\n    ...options,\n  };\n\n  // Add the server specific configuration.\n  const serverConfig: InlineConfig = mergeConfig(\n    getViteSharedConfig(mergedOptions, options.clearScreen, context),\n    {\n      build: getViteBuildOptions(mergedOptions, context),\n      server: getViteServerOptions(mergedOptions, context),\n    }\n  );\n\n  if (serverConfig.mode === 'production') {\n    console.warn('WARNING: serve is not meant to be run in production!');\n  }\n\n  try {\n    const server = await createServer(serverConfig);\n    await runViteDevServer(server);\n    const resolvedUrls = [\n      ...server.resolvedUrls.local,\n      ...server.resolvedUrls.network,\n    ];\n\n    yield {\n      success: true,\n      baseUrl: resolvedUrls[0] ?? '',\n    };\n  } catch (e) {\n    console.error(e);\n    yield {\n      success: false,\n      baseUrl: '',\n    };\n  }\n\n  // This Promise intentionally never resolves, leaving the process running\n  await new Promise<{ success: boolean }>(() => {});\n}\n\nasync function runViteDevServer(server: ViteDevServer): Promise<void> {\n  await server.listen();\n  server.printUrls();\n\n  const processOnExit = async () => {\n    await server.close();\n    process.off('SIGINT', processOnExit);\n    process.off('SIGTERM', processOnExit);\n    process.off('exit', processOnExit);\n  };\n\n  process.on('SIGINT', processOnExit);\n  process.on('SIGTERM', processOnExit);\n  process.on('exit', processOnExit);\n}\n"],"names":["viteDevServerExecutor","options","context","buildTargetOptions","getNxTargetOptions","buildTarget","mergedOptions","serverConfig","mergeConfig","getViteSharedConfig","clearScreen","build","getViteBuildOptions","server","getViteServerOptions","mode","console","warn","createServer","runViteDevServer","resolvedUrls","local","network","success","baseUrl","e","error","Promise","listen","printUrls","processOnExit","close","process","off","on"],"mappings":"AAAA;+BAcA;;aAA+BA;;;QAdxB;sBAEgE;8BAOhE;AAKQ,gBAAgBA,sBAC7BC,OAAqC,EACrCC,OAAwB,EAC+B;IACvD,sDAAsD;IACtD,MAAMC,qBAA+CC,IAAAA,gCAAkB,EACrEH,QAAQI,WAAW,EACnBH;IAGF,0DAA0D;IAC1D,+BAA+B;IAC/B,MAAMI,gBAAgB,aACjBH,oBACAF;IAGL,yCAAyC;IACzC,MAAMM,eAA6BC,IAAAA,iBAAW,EAC5CC,IAAAA,iCAAmB,EAACH,eAAeL,QAAQS,WAAW,EAAER,UACxD;QACES,OAAOC,IAAAA,iCAAmB,EAACN,eAAeJ;QAC1CW,QAAQC,IAAAA,kCAAoB,EAACR,eAAeJ;IAC9C;IAGF,IAAIK,aAAaQ,IAAI,KAAK,cAAc;QACtCC,QAAQC,IAAI,CAAC;IACf,CAAC;IAED,IAAI;QACF,MAAMJ,SAAS,MAAMK,IAAAA,kBAAY,EAACX;QAClC,MAAMY,iBAAiBN;QACvB,MAAMO,eAAe;eAChBP,OAAOO,YAAY,CAACC,KAAK;eACzBR,OAAOO,YAAY,CAACE,OAAO;SAC/B;YAIUF;QAFX,MAAM;YACJG,SAAS,IAAI;YACbC,SAASJ,CAAAA,MAAAA,YAAY,CAAC,EAAE,YAAfA,MAAmB,EAAE;QAChC;IACF,EAAE,OAAOK,GAAG;QACVT,QAAQU,KAAK,CAACD;QACd,MAAM;YACJF,SAAS,KAAK;YACdC,SAAS;QACX;IACF;IAEA,yEAAyE;IACzE,MAAM,IAAIG,QAA8B,IAAM,CAAC;AACjD;AAEA,eAAeR,iBAAiBN,MAAqB,EAAiB;IACpE,MAAMA,OAAOe,MAAM;IACnBf,OAAOgB,SAAS;IAEhB,MAAMC,gBAAgB,UAAY;QAChC,MAAMjB,OAAOkB,KAAK;QAClBC,QAAQC,GAAG,CAAC,UAAUH;QACtBE,QAAQC,GAAG,CAAC,WAAWH;QACvBE,QAAQC,GAAG,CAAC,QAAQH;IACtB;IAEAE,QAAQE,EAAE,CAAC,UAAUJ;IACrBE,QAAQE,EAAE,CAAC,WAAWJ;IACtBE,QAAQE,EAAE,CAAC,QAAQJ;AACrB"}